# 수문 데이터 시스템 구현 계획서

**작성일**: 2025-12-21
**기준 문서**: 엑셀_분석_보고서.md

---

## 1. 현재 상태 분석

### 1.1 구현 완료된 기능

| 기능 | 경로 | 상태 |
|------|------|------|
| 유량측정 데이터 입력 | `/measurement/data-input/` | ✅ 완료 |
| 유속계 관리 (검정식) | `/measurement/meters/` | ✅ 완료 |
| 유속 자동 계산 | V = a + b × (N/T) | ✅ 완료 |
| 유량 자동 계산 | 중앙단면법 | ✅ 완료 |
| 횡단면도 시각화 | Chart.js | ✅ 완료 |
| PDF 보고서 | `/measurement/report/` | ✅ 완료 |
| 측정 세션 저장 | DB 저장 | ✅ 완료 |
| **분석결과표** | `/measurement/analysis/` | ✅ 완료 |
| **Rating Curve** | `/measurement/rating-curve/` | ✅ 완료 |

### 1.2 구현 필요한 기능 (엑셀 분석 기반)

| 우선순위 | 기능 | 설명 | 난이도 |
|----------|------|------|--------|
| **높음** | 분석결과표 자동 생성 | 여러 측정 세션을 종합한 요약표 | 중 |
| **높음** | Rating Curve 자동 작성 | 측정 데이터로 Q=a(h-h0)^b 회귀분석 | 상 |
| **중간** | Excel/CSV 임포트 | 기존 데이터 대량 업로드 | 중 |
| **중간** | 시계열 데이터 조회 | 수위-유량 시계열 차트 | 중 |
| **낮음** | 기상 데이터 API 연동 | 기상청 API | 하 |

---

## 2. 상세 구현 계획

### 2.1 분석결과표 자동 생성

**목표**: 경주_대종천_2025년_종합.xlsx의 "분석값종합" 시트와 같은 요약표 생성

**필요 데이터 (입력)**:
- 측정 세션 목록 (MeasurementSession)
- 각 세션별: 지점명, 측정일, 측정 위치 (보상류/보하류)
- 계산 결과: 수면폭, 단면적, 평균유속, 유량

**출력 항목**:
| 항목 | 단위 | 계산 방법 |
|------|------|----------|
| 수면폭 | m | max(거리) - min(거리) |
| 단면적 | m² | Σ(폭 × 수심) |
| 윤변 | m | 수심 변화 누적 거리 |
| 동수반경 | m | 단면적 / 윤변 |
| 평균유속 | m/s | 유량 / 단면적 |
| 평균유량 | m³/s | Σ(부분유량) |
| 유속측선수 | 개 | count(유속 > 0) |

**구현 단계**:
- [x] 2.1.1 분석결과표 모델 설계 ✅ 완료
- [x] 2.1.2 계산 로직 구현 ✅ 완료
- [x] 2.1.3 조회 API 작성 ✅ 완료
- [x] 2.1.4 UI 페이지 구현 ✅ 완료
- [x] 2.1.5 Excel 다운로드 기능 ✅ 완료

---

### 2.2 Rating Curve 자동 작성

**목표**: 측정 데이터(수위, 유량)로 수위-유량 곡선 회귀분석

**회귀식**: Q = a × (h - h0)^b

**필요 데이터 (입력)**:
- 측정 세션들의 (수위, 유량) 쌍
- 최소 5개 이상의 데이터 포인트

**출력**:
- 계수: a, b, h0
- 결정계수: R²
- RMSE
- 곡선 차트

**구현 단계**:
- [x] 2.2.1 회귀분석 알고리즘 (scipy.optimize) ✅ 완료
- [x] 2.2.2 RatingCurve 모델 연동 ✅ 완료
- [x] 2.2.3 차트 시각화 ✅ 완료
- [x] 2.2.4 UI 페이지 ✅ 완료

---

### 2.3 CSV/Parquet 데이터 임포트

**목표**: 기존 야장 데이터를 사이트에 업로드

**지원 형식**:
1. CSV (거리, 수심, N, T)
2. Parquet (대용량 데이터)

**구현 단계**:
- [x] 2.3.1 업로드 UI ✅ 완료
- [x] 2.3.2 파싱 로직 (pandas) ✅ 완료
- [x] 2.3.3 데이터 검증 ✅ 완료
- [x] 2.3.4 MeasurementSession 저장 ✅ 완료

---

### 2.4 시계열 데이터 조회

**목표**: 경주_구길교 시간격 데이터와 같은 시계열 차트

**기능**:
- 기간 선택 (시작일~종료일)
- 수위/유량 동시 표시
- 강수량 오버레이 (옵션)

**구현 단계**:
- [ ] 2.4.1 시계열 모델 확인 (WaterLevelTimeSeries, DischargeTimeSeries)
- [ ] 2.4.2 조회 API
- [ ] 2.4.3 Chart.js 시계열 차트
- [ ] 2.4.4 UI 페이지

---

## 3. 작업 우선순위

### Phase 1 (즉시)
1. ✅ 유속계 검정식 연동 완료
2. 분석결과표 자동 생성

### Phase 2 (단기)
3. Rating Curve 자동 작성
4. Excel 임포트 기능

### Phase 3 (중기)
5. 시계열 데이터 조회
6. 기상 데이터 연동

---

## 4. 진행 상황

| 날짜 | 작업 내용 | 상태 |
|------|----------|------|
| 2025-12-21 | 엑셀 분석 보고서 작성 | ✅ 완료 |
| 2025-12-21 | 유속계 검정식 연동 | ✅ 완료 |
| 2025-12-21 | 구현 계획서 작성 | ✅ 완료 |
| 2025-12-21 | 분석결과표 자동 생성 | ✅ 완료 |
| 2025-12-21 | Rating Curve 확인 | ✅ 완료 (기존 구현) |
| 2025-12-21 | CSV/Parquet 임포트 | ✅ 완료 |

---

## 5. 참고 자료

- `resource/엑셀_분석_보고서.md` - 원본 엑셀 분석
- `resource/구길교_시간격데이터_샘플.csv` - 시계열 데이터 샘플
- `resource/대종천_분석결과표.csv` - 측정 결과 종합 샘플

---

## 6. VBA 입력 시스템 동기화 (2025-12-29)

**목표**: 기존 VBA 엑셀 입력 시스템과 웹 UI 완전 동기화

### 6.1 데이터 입력 페이지 개선

| 항목 | 내용 | 상태 |
|------|------|------|
| N/T 필드 | 측정법과 무관하게 항상 입력 가능 | ✅ 완료 |
| 각도/index 전환 | 헤더 클릭으로 전환, 각도 입력 시 cos(θ) 자동 환산 | ✅ 완료 |
| 측선별 유속계 | 드롭다운으로 1번/2번/3번 선택 가능 | ✅ 완료 |
| 검정계수 적용 | 유속계별 a, b 계수 자동 적용 | ✅ 완료 |
| 헤더 명칭 | N→회전수, T(s)→측정시간, 0.2D→V0.2, 0.6D→V0.6, 0.8D→V0.8 | ✅ 완료 |

### 6.2 불확실도 계산 (ISO 748)

| 항목 | 내용 | 상태 |
|------|------|------|
| X1Q (랜덤 불확실도) | Xm(측선수) + Xp(측점수) + Xc(유속계) + Xe(측점) | ✅ 완료 |
| X2Q (시스템 불확실도) | √(0.5² + 0.5² + 1.0²) = 1.22% | ✅ 완료 |
| 합성 불확실도 | √(X1Q² + X2Q²) | ✅ 완료 |
| 확장 불확실도 | 합성 × 2 (k=2, 95% 신뢰수준) | ✅ 완료 |
| 유량 등급 | E(<5%), G(<8%), F(<15%), P(≥15%) | ✅ 완료 |

### 6.3 추가 관측 정보 필드

| 필드 | 설명 | 상태 |
|------|------|------|
| 하천수 상태 | 맑음/혼탁/매우혼탁 선택 | ✅ 완료 |
| 유사량 | 텍스트 입력 | ✅ 완료 |
| 생물 정보 (Bio) | 텍스트 입력 | ✅ 완료 |

### 6.4 관련 커밋

| 커밋 | 내용 |
|------|------|
| `197cea6` | 데이터 입력 페이지 VBA 입력 시스템 동기화 |
| `779951a` | ISO 748 불확실도 계산, 추가 필드 |
| `30f25ad` | 헤더 명칭 변경 (실무 장표 일치) |

---

## 7. 향후 계획 (사용자 피드백 기반)

### 7.1 댐 수문 영향 표기 (박승혁 요청)

| 항목 | 내용 | 상태 |
|------|------|------|
| API 연동 | 한국수자원공사 수문 방류정보 조회 API | ⏳ 대기 |
| 영향 판단 | 댐-관측소 도달시간 고려 | ⏳ 대기 |
| UI 표시 | 유량값에 댐 영향 배지 표시 | ⏳ 대기 |

### 7.2 유역유출고 평가

| 항목 | 내용 | 상태 |
|------|------|------|
| 유역면적 입력 | 직접 입력 또는 GIS 산정 | ⏳ 대기 |
| 예상 유출량 | 합리식/단위유량도법 | ⏳ 대기 |
| 측정값 비교 | 현장 측정값과 예상값 비교 | ⏳ 대기 |
