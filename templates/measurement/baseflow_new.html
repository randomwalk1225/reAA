{% extends "base.html" %}

{% block title %}새 기저유출 분석 - 유량측정 시스템{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="baseflowAnalysis()">
    <!-- Toast Notification -->
    <div x-show="toast.show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-4"
         class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50"
         x-cloak>
        <div class="flex items-center px-6 py-3 rounded-lg shadow-lg"
             :class="toast.type === 'success' ? 'bg-emerald-600 text-white' : 'bg-red-600 text-white'">
            <svg x-show="toast.type === 'success'" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <svg x-show="toast.type === 'error'" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            <span x-text="toast.message"></span>
        </div>
    </div>

    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'measurement:baseflow_list' %}" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-4">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            분석 목록으로
        </a>
        <h1 class="text-2xl font-bold text-gray-900">새 기저유출 분석</h1>
        <p class="mt-1 text-gray-600">유량 시계열에서 기저유출을 분리합니다</p>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
        <!-- Settings Panel -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border p-6 lg:sticky lg:top-24">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">분석 설정</h2>

                <!-- Data Source Toggle -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">데이터 소스</label>
                    <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                        <button type="button"
                                @click="dataSource = 'internal'"
                                :class="dataSource === 'internal' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                                class="flex-1 px-3 py-2 text-sm font-medium transition-colors">
                            내부 관측소
                        </button>
                        <button type="button"
                                @click="dataSource = 'hrfco'"
                                :class="dataSource === 'hrfco' ? 'bg-primary-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                                class="flex-1 px-3 py-2 text-sm font-medium transition-colors border-l border-gray-300">
                            HRFCO API
                        </button>
                    </div>
                </div>

                <!-- Internal Station Selection -->
                <div class="mb-4" x-show="dataSource === 'internal'" x-cloak>
                    <label class="block text-sm font-medium text-gray-700 mb-2">내부 관측소</label>
                    <select x-model="selectedInternalStationId"
                            @change="selectInternalStation()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm">
                        <option value="">관측소 선택...</option>
                        {% for station in internal_stations %}
                        <option value="{{ station.id }}">{{ station.name }} ({{ station.river_name }})</option>
                        {% endfor %}
                    </select>
                    <div x-show="selectedInternalStation" x-cloak class="mt-2">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs bg-emerald-100 text-emerald-800">
                            <span x-text="selectedInternalStation?.name"></span>
                            <span class="mx-1">·</span>
                            <span x-text="selectedInternalStation?.river"></span>
                        </span>
                    </div>
                </div>

                <!-- HRFCO Station Selection with Search -->
                <div class="mb-4" x-show="dataSource === 'hrfco'" x-cloak>
                    <label class="block text-sm font-medium text-gray-700 mb-2">관측소 (한강홍수통제소)</label>
                    <div class="relative" @click.outside="showStationDropdown = false">
                        <div class="relative">
                            <input type="text"
                                   x-model="stationSearch"
                                   @focus="showStationDropdown = true; filterStations()"
                                   @input="filterStations()"
                                   @keydown.escape="showStationDropdown = false"
                                   @keydown.arrow-down.prevent="navigateDropdown(1)"
                                   @keydown.arrow-up.prevent="navigateDropdown(-1)"
                                   @keydown.enter.prevent="selectHighlightedStation()"
                                   :placeholder="selectedStation ? selectedStation.name : '관측소 검색...'"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 pr-10 text-sm">
                            <button type="button"
                                    @click="showStationDropdown = !showStationDropdown; if(showStationDropdown) filterStations()"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
                                <svg class="w-5 h-5" :class="{'rotate-180': showStationDropdown}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Dropdown -->
                        <div x-show="showStationDropdown"
                             x-transition
                             class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-56 overflow-y-auto">
                            <template x-for="(station, index) in filteredStations" :key="station.code">
                                <div @click="selectStation(station)"
                                     :class="{'bg-gray-100': highlightedIndex === index}"
                                     class="px-3 py-2 cursor-pointer hover:bg-gray-50 border-b border-gray-100 last:border-0">
                                    <div class="font-medium text-sm text-gray-900" x-text="station.name"></div>
                                    <div class="text-xs text-gray-500">
                                        <span x-text="station.river"></span> ·
                                        <span x-text="station.region"></span>
                                    </div>
                                </div>
                            </template>
                            <div x-show="filteredStations.length === 0" class="px-3 py-4 text-center text-gray-500 text-sm">
                                검색 결과가 없습니다
                            </div>
                        </div>
                    </div>

                    <!-- Selected station badge -->
                    <div x-show="selectedStation" x-cloak class="mt-2">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs bg-blue-100 text-blue-800">
                            <span x-text="selectedStation?.name"></span>
                            <span class="mx-1">·</span>
                            <span x-text="selectedStation?.river"></span>
                            <button @click="clearStation()" class="ml-1 hover:text-blue-600">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </span>
                    </div>
                </div>

                <!-- Period -->
                <div class="mb-4 grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">시작일</label>
                        <input type="date" x-model="startDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">종료일</label>
                        <input type="date" x-model="endDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Load Data Button -->
                <button @click="loadStationData()"
                        :disabled="(dataSource === 'hrfco' && !selectedStation) || (dataSource === 'internal' && !selectedInternalStationId) || loadingData"
                        class="w-full mb-4 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!loadingData">데이터 불러오기</span>
                    <span x-show="loadingData" class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        불러오는 중...
                    </span>
                </button>

                <!-- Data Info -->
                <div x-show="dischargeData.length > 0" x-cloak class="mb-4 p-3 bg-gray-50 rounded-lg text-sm">
                    <div class="flex justify-between text-gray-600">
                        <span>데이터 기간:</span>
                        <span class="font-medium" x-text="dataInfo.period"></span>
                    </div>
                    <div class="flex justify-between text-gray-600 mt-1">
                        <span>데이터 수:</span>
                        <span class="font-medium" x-text="dataInfo.count + '일'"></span>
                    </div>
                </div>

                <hr class="my-4">

                <!-- Method -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">분석 방법</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer"
                               :class="method === 'lyne_hollick' ? 'border-primary-500 bg-primary-50' : 'border-gray-200'">
                            <input type="radio" x-model="method" value="lyne_hollick" class="mr-3">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Lyne-Hollick 필터</p>
                                <p class="text-xs text-gray-500">단일 매개변수 재귀 필터</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer"
                               :class="method === 'eckhardt' ? 'border-primary-500 bg-primary-50' : 'border-gray-200'">
                            <input type="radio" x-model="method" value="eckhardt" class="mr-3">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Eckhardt 필터</p>
                                <p class="text-xs text-gray-500">BFImax 제약 포함</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Parameters -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">필터 계수 (α)</label>
                    <input type="range" x-model="alpha" min="0.9" max="0.99" step="0.005"
                           class="w-full" @input="debouncedRunAnalysis()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0.90</span>
                        <span class="font-medium text-gray-900" x-text="alpha"></span>
                        <span>0.99</span>
                    </div>
                </div>

                <!-- BFImax (for Eckhardt) -->
                <div x-show="method === 'eckhardt'" x-cloak class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">BFImax</label>
                    <input type="range" x-model="bfiMax" min="0.5" max="0.95" step="0.05"
                           class="w-full" @input="debouncedRunAnalysis()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0.50</span>
                        <span class="font-medium text-gray-900" x-text="bfiMax"></span>
                        <span>0.95</span>
                    </div>
                </div>

                <!-- Run Analysis Button -->
                <button @click="runAnalysis()"
                        :disabled="dischargeData.length === 0 || analyzing"
                        class="w-full px-4 py-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!analyzing">분석 실행</span>
                    <span x-show="analyzing" class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        분석 중...
                    </span>
                </button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="lg:col-span-2">
            <!-- Statistics -->
            <div x-show="results" x-cloak class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">분석 결과</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">총유출량</p>
                        <p class="text-xl font-bold text-gray-900" x-text="results?.total_runoff?.toFixed(1) + ' mm'"></p>
                    </div>
                    <div class="bg-emerald-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">기저유출량</p>
                        <p class="text-xl font-bold text-emerald-600" x-text="results?.baseflow?.toFixed(1) + ' mm'"></p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">직접유출량</p>
                        <p class="text-xl font-bold text-blue-600" x-text="results?.direct_runoff?.toFixed(1) + ' mm'"></p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">BFI</p>
                        <p class="text-2xl font-bold text-amber-600" x-text="results?.bfi?.toFixed(3)"></p>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">기저유출 분리 그래프</h2>
                <div x-show="dischargeData.length === 0" class="flex flex-col items-center justify-center py-12 text-gray-400">
                    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <p class="text-sm">관측소를 선택하고 데이터를 불러오세요</p>
                </div>
                <div x-show="dischargeData.length > 0" class="relative w-full" style="height: 300px; min-height: 250px;">
                    <canvas id="baseflowChart" class="w-full h-full"></canvas>
                </div>
            </div>

            <!-- Save Button -->
            <div x-show="results" x-cloak class="flex justify-end space-x-3">
                <button @click="exportResults()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    결과 내보내기
                </button>
                <button @click="saveAnalysis()" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    분석 결과 저장
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function baseflowAnalysis() {
    // HRFCO 관측소 목록
    const hrfcoStations = [
        {% for station in hrfco_stations %}
        { code: '{{ station.code }}', name: '{{ station.name }}', river: '{{ station.river }}', region: '{{ station.region }}' },
        {% endfor %}
    ];

    // 내부 관측소 목록
    const internalStations = {
        {% for station in internal_stations %}
        '{{ station.id }}': { id: {{ station.id }}, name: '{{ station.name }}', river: '{{ station.river_name }}' },
        {% endfor %}
    };

    // URL에서 자동 선택된 관측소
    const preselectedStationId = '{{ selected_internal_station.id|default:"" }}';

    return {
        // 데이터 소스 (internal / hrfco)
        dataSource: preselectedStationId ? 'internal' : 'internal',

        // 내부 관측소 관련
        internalStations: internalStations,
        selectedInternalStationId: preselectedStationId,
        selectedInternalStation: preselectedStationId ? internalStations[preselectedStationId] : null,

        // HRFCO 관측소 관련
        allStations: hrfcoStations,
        filteredStations: [],
        selectedStation: null,
        stationSearch: '',
        showStationDropdown: false,
        highlightedIndex: -1,

        // 기간
        startDate: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        endDate: new Date().toISOString().split('T')[0],

        // 분석 설정
        method: 'lyne_hollick',
        alpha: 0.925,
        bfiMax: 0.80,

        // 상태
        loadingData: false,
        analyzing: false,
        results: null,
        chart: null,

        // 데이터
        dischargeData: [],
        baseflowData: [],
        dateLabels: [],
        dataInfo: { period: '', count: 0 },

        // 토스트
        toast: { show: false, message: '', type: 'success' },
        debounceTimer: null,

        selectInternalStation() {
            if (this.selectedInternalStationId) {
                this.selectedInternalStation = this.internalStations[this.selectedInternalStationId];
            } else {
                this.selectedInternalStation = null;
            }
        },

        init() {
            this.filteredStations = [...this.allStations];

            // 자동 선택된 관측소가 있으면 데이터 자동 로드
            if (this.selectedInternalStationId && this.selectedInternalStation) {
                this.$nextTick(() => {
                    setTimeout(() => this.loadStationData(), 100);
                });
            }

            this.$nextTick(() => {
                setTimeout(() => this.initChart(), 50);
            });

            window.addEventListener('resize', () => {
                if (this.chart) this.chart.resize();
            });
        },

        filterStations() {
            const query = this.stationSearch.toLowerCase().trim();
            if (!query) {
                this.filteredStations = [...this.allStations];
            } else {
                this.filteredStations = this.allStations.filter(s =>
                    s.name.toLowerCase().includes(query) ||
                    s.river.toLowerCase().includes(query) ||
                    s.region.toLowerCase().includes(query) ||
                    s.code.includes(query)
                );
            }
            this.highlightedIndex = -1;
        },

        navigateDropdown(direction) {
            if (!this.showStationDropdown) {
                this.showStationDropdown = true;
                return;
            }
            const max = this.filteredStations.length - 1;
            this.highlightedIndex += direction;
            if (this.highlightedIndex > max) this.highlightedIndex = 0;
            if (this.highlightedIndex < 0) this.highlightedIndex = max;
        },

        selectHighlightedStation() {
            if (this.highlightedIndex >= 0 && this.filteredStations[this.highlightedIndex]) {
                this.selectStation(this.filteredStations[this.highlightedIndex]);
            }
        },

        selectStation(station) {
            this.selectedStation = station;
            this.stationSearch = '';
            this.showStationDropdown = false;
            this.highlightedIndex = -1;
        },

        clearStation() {
            this.selectedStation = null;
            this.dischargeData = [];
            this.baseflowData = [];
            this.results = null;
            this.dataInfo = { period: '', count: 0 };
            if (this.chart) {
                this.chart.data.labels = [];
                this.chart.data.datasets[0].data = [];
                this.chart.data.datasets[1].data = [];
                this.chart.update();
            }
        },

        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => this.toast.show = false, 1500);
        },

        async loadStationData() {
            // 데이터 소스에 따른 유효성 검사
            if (this.dataSource === 'hrfco' && !this.selectedStation) return;
            if (this.dataSource === 'internal' && !this.selectedInternalStationId) return;
            if (this.loadingData) return;

            this.loadingData = true;
            this.results = null;

            try {
                let url, params;

                if (this.dataSource === 'internal') {
                    // 내부 관측소 데이터 (WaterLevelTimeSeries + RatingCurve)
                    params = new URLSearchParams({
                        station_id: this.selectedInternalStationId,
                        start_date: this.startDate,
                        end_date: this.endDate
                    });
                    url = `{% url "measurement:api_internal_discharge" %}?${params}`;
                } else {
                    // HRFCO API
                    params = new URLSearchParams({
                        station_code: this.selectedStation.code,
                        start_date: this.startDate,
                        end_date: this.endDate
                    });
                    url = `{% url "measurement:api_hrfco_discharge" %}?${params}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.discharge.length > 0) {
                    this.dischargeData = data.discharge;
                    this.dateLabels = data.dates;
                    this.dataInfo = {
                        period: `${data.start_date} ~ ${data.end_date}`,
                        count: data.count
                    };

                    // 차트 초기 표시 (유량만)
                    this.updateChartData();
                    this.showToast(`${data.count}일 데이터를 불러왔습니다`);
                } else {
                    const errorMsg = data.error || '유량 데이터가 없습니다. 다른 관측소를 선택하세요.';
                    this.showToast(errorMsg, 'error');
                    this.dischargeData = [];
                }
            } catch (error) {
                this.showToast('데이터 로드 실패: ' + error.message, 'error');
            } finally {
                this.loadingData = false;
            }
        },

        debouncedRunAnalysis() {
            if (this.debounceTimer) clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => this.runAnalysis(), 150);
        },

        initChart() {
            const canvas = document.getElementById('baseflowChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            try {
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: '총유량 (m³/s)',
                                data: [],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0,
                            },
                            {
                                label: '기저유출 (m³/s)',
                                data: [],
                                borderColor: 'rgb(16, 185, 129)',
                                backgroundColor: 'rgba(16, 185, 129, 0.3)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: { display: true, text: '날짜' },
                                ticks: { maxTicksLimit: 12 }
                            },
                            y: {
                                display: true,
                                title: { display: true, text: '유량 (m³/s)' },
                                min: 0
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Chart init failed:', e);
            }
        },

        updateChartData() {
            if (!this.chart) {
                this.initChart();
                if (!this.chart) return;
            }

            this.chart.data.labels = this.dateLabels;
            this.chart.data.datasets[0].data = this.dischargeData;
            this.chart.data.datasets[1].data = this.baseflowData;
            this.chart.update();
        },

        async runAnalysis() {
            if (this.analyzing || this.dischargeData.length === 0) return;

            this.analyzing = true;

            try {
                const response = await fetch('{% url "measurement:run_baseflow_analysis" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        method: this.method,
                        alpha: parseFloat(this.alpha),
                        bfi_max: parseFloat(this.bfiMax),
                        discharge: this.dischargeData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.results = result.statistics;
                    this.baseflowData = result.baseflow;
                    this.updateChartData();
                } else {
                    this.showToast('분석 오류: ' + result.error, 'error');
                }
            } catch (error) {
                this.showToast('분석 중 오류 발생: ' + error.message, 'error');
            } finally {
                this.analyzing = false;
            }
        },

        exportResults() {
            if (!this.results) return;

            let content = 'date,total_discharge,baseflow,direct_runoff\n';
            for (let i = 0; i < this.dischargeData.length; i++) {
                const direct = this.dischargeData[i] - this.baseflowData[i];
                content += `${this.dateLabels[i]},${this.dischargeData[i].toFixed(4)},${this.baseflowData[i].toFixed(4)},${direct.toFixed(4)}\n`;
            }

            const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `baseflow_${this.selectedStation?.name || 'analysis'}.csv`;
            a.click();
        },

        async saveAnalysis() {
            if (!this.results || !this.selectedStation) return;

            const dailyData = [];
            for (let i = 0; i < this.dischargeData.length; i++) {
                dailyData.push({
                    date: this.dateLabels[i],
                    total: this.dischargeData[i],
                    baseflow: this.baseflowData[i],
                    direct: this.dischargeData[i] - this.baseflowData[i]
                });
            }

            try {
                const response = await fetch('{% url "measurement:save_baseflow_analysis" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        station_name: this.selectedStation.name,
                        method: this.method,
                        alpha: parseFloat(this.alpha),
                        bfi_max: this.method === 'eckhardt' ? parseFloat(this.bfiMax) : null,
                        start_date: this.dateLabels[0],
                        end_date: this.dateLabels[this.dateLabels.length - 1],
                        statistics: this.results,
                        daily_data: dailyData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.showToast('분석 결과가 저장되었습니다', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "measurement:baseflow_list" %}';
                    }, 1500);
                } else {
                    this.showToast('저장 실패: ' + result.error, 'error');
                }
            } catch (error) {
                this.showToast('저장 중 오류 발생: ' + error.message, 'error');
            }
        }
    };
}
</script>
{% endblock %}
