{% extends "base.html" %}

{% block title %}새 기저유출 분석 - 유량측정 시스템{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="baseflowAnalysis()">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'measurement:baseflow_list' %}" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-4">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            분석 목록으로
        </a>
        <h1 class="text-2xl font-bold text-gray-900">새 기저유출 분석</h1>
        <p class="mt-1 text-gray-600">유량 시계열에서 기저유출을 분리합니다</p>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
        <!-- Settings Panel -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border p-6 sticky top-24">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">분석 설정</h2>

                <!-- Station Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">관측소</label>
                    <select x-model="stationId" @change="loadStationData()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        <option value="">관측소 선택</option>
                        <option value="1">경주 대종천 하류보</option>
                        <option value="2">신태인 수위관측소</option>
                    </select>
                </div>

                <!-- Period -->
                <div class="mb-4 grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">시작일</label>
                        <input type="date" x-model="startDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">종료일</label>
                        <input type="date" x-model="endDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Method -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">분석 방법</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer"
                               :class="method === 'lyne_hollick' ? 'border-primary-500 bg-primary-50' : 'border-gray-200'">
                            <input type="radio" x-model="method" value="lyne_hollick" class="mr-3">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Lyne-Hollick 필터</p>
                                <p class="text-xs text-gray-500">단일 매개변수 재귀 필터</p>
                            </div>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg cursor-pointer"
                               :class="method === 'eckhardt' ? 'border-primary-500 bg-primary-50' : 'border-gray-200'">
                            <input type="radio" x-model="method" value="eckhardt" class="mr-3">
                            <div>
                                <p class="text-sm font-medium text-gray-900">Eckhardt 필터</p>
                                <p class="text-xs text-gray-500">BFImax 제약 포함</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Parameters -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">필터 계수 (α)</label>
                    <input type="range" x-model="alpha" min="0.9" max="0.99" step="0.005"
                           class="w-full" @input="debouncedRunAnalysis()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0.90</span>
                        <span class="font-medium text-gray-900" x-text="alpha"></span>
                        <span>0.99</span>
                    </div>
                </div>

                <!-- BFImax (for Eckhardt) -->
                <div x-show="method === 'eckhardt'" x-cloak class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">BFImax</label>
                    <input type="range" x-model="bfiMax" min="0.5" max="0.95" step="0.05"
                           class="w-full" @input="debouncedRunAnalysis()">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0.50</span>
                        <span class="font-medium text-gray-900" x-text="bfiMax"></span>
                        <span>0.95</span>
                    </div>
                </div>

                <!-- Run Analysis Button -->
                <button @click="runAnalysis()"
                        :disabled="!stationId || analyzing"
                        class="w-full px-4 py-3 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!analyzing">분석 실행</span>
                    <span x-show="analyzing" class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        분석 중...
                    </span>
                </button>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="lg:col-span-2">
            <!-- Statistics -->
            <div x-show="results" x-cloak class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">분석 결과</h2>
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">총유출량</p>
                        <p class="text-xl font-bold text-gray-900" x-text="results?.total_runoff?.toFixed(1) + ' mm'"></p>
                    </div>
                    <div class="bg-emerald-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">기저유출량</p>
                        <p class="text-xl font-bold text-emerald-600" x-text="results?.baseflow?.toFixed(1) + ' mm'"></p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">직접유출량</p>
                        <p class="text-xl font-bold text-blue-600" x-text="results?.direct_runoff?.toFixed(1) + ' mm'"></p>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-4 text-center">
                        <p class="text-xs text-gray-500 mb-1">BFI</p>
                        <p class="text-2xl font-bold text-amber-600" x-text="results?.bfi?.toFixed(3)"></p>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">기저유출 분리 그래프</h2>
                <div style="height: 400px;">
                    <canvas id="baseflowChart"></canvas>
                </div>
            </div>

            <!-- Save Button -->
            <div x-show="results" x-cloak class="flex justify-end space-x-3">
                <button @click="exportResults()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    결과 내보내기
                </button>
                <button @click="saveAnalysis()" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                    분석 결과 저장
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function baseflowAnalysis() {
    return {
        stationId: '',
        startDate: '2024-05-01',
        endDate: '2025-04-30',
        method: 'lyne_hollick',
        alpha: 0.925,
        bfiMax: 0.80,
        analyzing: false,
        loading: false,
        results: null,
        chart: null,
        dischargeData: [],
        baseflowData: [],
        debounceTimer: null,

        init() {
            this.initChart();
            // URL 파라미터에서 station 읽기
            const params = new URLSearchParams(window.location.search);
            if (params.get('station')) {
                this.stationId = params.get('station');
                // 약간의 딜레이 후 로드 (DOM 안정화)
                setTimeout(() => this.loadStationData(), 100);
            }
        },

        loadStationData() {
            if (!this.stationId || this.loading) return;
            this.loading = true;

            // 샘플 데이터 생성 (실제로는 API 호출)
            const days = 365;
            const data = [];
            for (let i = 0; i < days; i++) {
                // 계절 변동 + 랜덤 강우 이벤트
                const seasonal = 0.5 + 0.3 * Math.sin(2 * Math.PI * i / 365);
                const event = Math.random() < 0.1 ? Math.random() * 3 : 0;
                data.push(Math.max(0.1, seasonal + event + (Math.random() - 0.5) * 0.2));
            }
            // 배열 한 번에 할당 (반응성 최소화)
            this.dischargeData = data;
            this.loading = false;

            // 디바운스된 분석 실행
            this.debouncedRunAnalysis();
        },

        debouncedRunAnalysis() {
            if (this.debounceTimer) clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => this.runAnalysis(), 150);
        },

        initChart() {
            const canvas = document.getElementById('baseflowChart');
            if (!canvas) {
                console.error('Chart canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Cannot get 2d context');
                return;
            }

            try {
                this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '총유량 (m³/s)',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                        },
                        {
                            label: '기저유출 (m³/s)',
                            data: [],
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: '일수'
                            },
                            ticks: {
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: '유량 (m³/s)'
                            },
                            min: 0
                        }
                    }
                }
            });
            } catch (e) {
                console.error('Chart init failed:', e);
                this.chart = null;
            }
        },

        async runAnalysis() {
            // 이미 분석 중이면 중복 실행 방지
            if (this.analyzing) return;
            if (!this.stationId || this.dischargeData.length === 0) return;

            this.analyzing = true;

            try {
                const response = await fetch('{% url "measurement:run_baseflow_analysis" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        method: this.method,
                        alpha: parseFloat(this.alpha),
                        bfi_max: parseFloat(this.bfiMax),
                        discharge: this.dischargeData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.results = result.statistics;
                    this.baseflowData = result.baseflow;
                    this.updateChart();
                } else {
                    alert('분석 오류: ' + result.error);
                }
            } catch (error) {
                alert('분석 중 오류 발생: ' + error.message);
            } finally {
                this.analyzing = false;
            }
        },

        updateChart() {
            if (!this.chart) {
                // 차트가 없으면 다시 초기화 시도
                this.initChart();
                if (!this.chart) return;
            }

            try {
                // 라벨 생성
                const labels = this.dischargeData.map((_, i) => i + 1);

                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = this.dischargeData;
                this.chart.data.datasets[1].data = this.baseflowData;
                this.chart.update('none'); // 애니메이션 없이 업데이트
            } catch (e) {
                console.error('Chart update failed:', e);
            }
        },

        exportResults() {
            if (!this.results) return;

            let content = 'day,total_discharge,baseflow,direct_runoff\n';
            for (let i = 0; i < this.dischargeData.length; i++) {
                const direct = this.dischargeData[i] - this.baseflowData[i];
                content += `${i + 1},${this.dischargeData[i].toFixed(4)},${this.baseflowData[i].toFixed(4)},${direct.toFixed(4)}\n`;
            }

            const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'baseflow_analysis.csv';
            a.click();
        },

        saveAnalysis() {
            if (!this.results) return;
            alert('분석 결과가 저장되었습니다. BFI = ' + this.results.bfi.toFixed(3));
            window.location.href = '{% url "measurement:baseflow_list" %}';
        }
    };
}
</script>
{% endblock %}
