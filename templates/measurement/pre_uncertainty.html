{% extends "base.html" %}

{% block title %}ì‚¬ì „ ë¶ˆí™•ì‹¤ë„ ë¶„ì„ - ìœ ëŸ‰ì¸¡ì • ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-6 px-4 sm:px-6 lg:px-8" x-data="preUncertainty()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">ì‚¬ì „ ë¶ˆí™•ì‹¤ë„ ë¶„ì„</h1>
        <p class="mt-1 text-gray-600">ì¸¡ì • ì „ ì˜ˆìƒ ë¶ˆí™•ì‹¤ë„ë¥¼ ì¶”ì •í•˜ì—¬ ì¸¡ì • ê³„íš ìˆ˜ë¦½ì— í™œìš©í•©ë‹ˆë‹¤</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input Form -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">ì˜ˆìƒ ì¸¡ì • ì¡°ê±´</h2>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆìƒ ì¸¡ì„  ìˆ˜</label>
                    <input type="number" x-model="conditions.verticals" @input="calculate"
                           min="5" max="50" placeholder="10"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <p class="text-xs text-gray-500 mt-1">ê¶Œì¥: 10ê°œ ì´ìƒ</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ˆìƒ í‰ê·  ìˆ˜ì‹¬ (m)</label>
                    <input type="number" x-model="conditions.avgDepth" @input="calculate"
                           min="0.1" max="10" step="0.1" placeholder="0.8"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">ìˆ˜ë©´ ìƒíƒœ</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="surface" value="good" x-model="conditions.surface" @change="calculate"
                                   class="w-4 h-4 text-primary-600">
                            <span class="ml-2 text-sm">ì–‘í˜¸</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="surface" value="normal" x-model="conditions.surface" @change="calculate"
                                   class="w-4 h-4 text-primary-600">
                            <span class="ml-2 text-sm">ë³´í†µ</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="surface" value="poor" x-model="conditions.surface" @change="calculate"
                                   class="w-4 h-4 text-primary-600">
                            <span class="ml-2 text-sm">ë¶ˆëŸ‰</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¸¡ì • ì‹œê°„ (ì´ˆ/ì )</label>
                    <input type="number" x-model="conditions.measurementTime" @input="calculate"
                           min="30" max="120" step="10" placeholder="60"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <p class="text-xs text-gray-500 mt-1">ê¶Œì¥: 60ì´ˆ ì´ìƒ</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìœ ì†ê³„</label>
                    <select x-model="conditions.meter" @change="calculate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                        <option value="PROP-001">PROP-001 (í”„ë¡œí ëŸ¬í˜•)</option>
                        <option value="PROP-002">PROP-002 (í”„ë¡œí ëŸ¬í˜•)</option>
                        <option value="ELEC-001">ELEC-001 (ì „ìì‹)</option>
                    </select>
                </div>

                <button type="button" @click="calculate"
                        class="w-full py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium">
                    ë¶ˆí™•ì‹¤ë„ ê³„ì‚°
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="space-y-6">
            <!-- Main Result -->
            <div class="bg-white rounded-xl shadow-sm border p-6 text-center">
                <p class="text-gray-500 mb-2">ì˜ˆìƒ ë¶ˆí™•ì‹¤ë„</p>
                <div class="text-5xl font-bold mb-2"
                     :class="result.total < 5 ? 'text-green-600' : result.total < 7 ? 'text-yellow-600' : 'text-red-600'">
                    Â±<span x-text="result.total.toFixed(1)"></span>%
                </div>
                <p class="text-gray-500">(95% ì‹ ë¢°ìˆ˜ì¤€, k=2)</p>

                <div class="mt-4 inline-flex items-center px-3 py-1 rounded-full text-sm"
                     :class="result.total < 5 ? 'bg-green-100 text-green-800' : result.total < 7 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'">
                    <span x-text="result.total < 5 ? 'ì–‘í˜¸' : result.total < 7 ? 'ë³´í†µ' : 'ê°œì„  í•„ìš”'"></span>
                </div>
            </div>

            <!-- Components -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="font-semibold text-gray-900 mb-4">ë¶ˆí™•ì‹¤ë„ êµ¬ì„±ìš”ì†Œ</h3>

                <div class="space-y-3">
                    <template x-for="(comp, key) in result.components" :key="key">
                        <div class="flex items-center justify-between py-2 border-b last:border-0">
                            <div>
                                <p class="font-medium text-gray-900" x-text="comp.name"></p>
                                <p class="text-xs text-gray-500" x-text="comp.desc"></p>
                            </div>
                            <div class="text-right">
                                <span class="font-medium" x-text="comp.value.toFixed(1) + '%'"></span>
                                <template x-if="comp.suggestion">
                                    <p class="text-xs text-amber-600" x-text="comp.suggestion"></p>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="mt-4 pt-4 border-t bg-gray-50 -mx-6 -mb-6 px-6 py-4 rounded-b-xl">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">í•©ì„±í‘œì¤€ë¶ˆí™•ì‹¤ë„</span>
                        <span class="font-bold text-lg" x-text="(result.total / 2).toFixed(1) + '%'"></span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">u(Q) = âˆš(XeÂ² + XpÂ² + XcÂ² + XmÂ²)</p>
                </div>
            </div>

            <!-- Improvement Tips -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4" x-show="result.tips.length > 0">
                <h3 class="font-semibold text-blue-900 mb-2">ê°œì„  ì œì•ˆ</h3>
                <ul class="space-y-1 text-sm text-blue-800">
                    <template x-for="tip in result.tips" :key="tip">
                        <li class="flex items-start">
                            <span class="mr-2">ğŸ’¡</span>
                            <span x-text="tip"></span>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function preUncertainty() {
    return {
        conditions: {
            verticals: 10,
            avgDepth: 0.8,
            surface: 'normal',
            measurementTime: 60,
            meter: 'PROP-001'
        },
        result: {
            total: 5.2,
            components: {
                xe: { name: 'Xe (ì¸¡ì )', desc: 'ì¸¡ì„  ìˆ˜ ê´€ë ¨', value: 2.0, suggestion: null },
                xp: { name: 'Xp (ìˆ˜ì‹¬)', desc: 'ìˆ˜ì‹¬ ì¸¡ì • ê´€ë ¨', value: 2.5, suggestion: null },
                xc: { name: 'Xc (ê²€ì •)', desc: 'ìœ ì†ê³„ ê²€ì • ê´€ë ¨', value: 1.0, suggestion: null },
                xm: { name: 'Xm (ì¸¡ì •)', desc: 'ìœ ì† ì¸¡ì • ê´€ë ¨', value: 3.5, suggestion: 'ì¸¡ì •ì‹œê°„ 90ì´ˆ ê¶Œì¥' }
            },
            tips: []
        },

        init() {
            this.calculate();
        },

        calculate() {
            // ì¸¡ì  ë¶ˆí™•ì‹¤ë„ (Xe) - ì¸¡ì„  ìˆ˜ì— ë”°ë¼ ê°ì†Œ
            const xe = Math.max(1.0, 6.0 / Math.sqrt(this.conditions.verticals));

            // ìˆ˜ì‹¬ ë¶ˆí™•ì‹¤ë„ (Xp) - ìˆ˜ë©´ ìƒíƒœì™€ ìˆ˜ì‹¬ì— ë”°ë¼
            const surfaceFactors = { good: 1.0, normal: 1.5, poor: 2.0 };
            const xp = surfaceFactors[this.conditions.surface] * (1.5 + 0.5 / this.conditions.avgDepth);

            // ê²€ì • ë¶ˆí™•ì‹¤ë„ (Xc) - ìœ ì†ê³„ì— ë”°ë¼ ê³ ì •
            const meterUncertainty = { 'PROP-001': 1.0, 'PROP-002': 1.2, 'ELEC-001': 0.8 };
            const xc = meterUncertainty[this.conditions.meter] || 1.0;

            // ì¸¡ì • ë¶ˆí™•ì‹¤ë„ (Xm) - ì¸¡ì • ì‹œê°„ì— ë”°ë¼
            const xm = Math.max(1.5, 5.0 - (this.conditions.measurementTime - 30) * 0.05);

            // í•©ì„± (RSS)
            const combined = Math.sqrt(xe*xe + xp*xp + xc*xc + xm*xm);
            const expanded = combined * 2; // k=2 for 95%

            // ê²°ê³¼ ì—…ë°ì´íŠ¸
            this.result.components.xe.value = xe;
            this.result.components.xp.value = xp;
            this.result.components.xc.value = xc;
            this.result.components.xm.value = xm;
            this.result.total = expanded;

            // ì œì•ˆ ìƒì„±
            this.result.tips = [];
            this.result.components.xe.suggestion = null;
            this.result.components.xm.suggestion = null;

            if (this.conditions.verticals < 10) {
                this.result.components.xe.suggestion = 'ì¸¡ì„  ìˆ˜ ì¦ê°€ ê¶Œì¥';
                this.result.tips.push(`ì¸¡ì„  ìˆ˜ë¥¼ ${this.conditions.verticals}ê°œì—ì„œ 10ê°œ ì´ìƒìœ¼ë¡œ ëŠ˜ë¦¬ë©´ Xeê°€ ê°ì†Œí•©ë‹ˆë‹¤.`);
            }

            if (this.conditions.measurementTime < 60) {
                this.result.components.xm.suggestion = 'ì¸¡ì •ì‹œê°„ 60ì´ˆ ê¶Œì¥';
                this.result.tips.push(`ì¸¡ì • ì‹œê°„ì„ ${this.conditions.measurementTime}ì´ˆì—ì„œ 60ì´ˆë¡œ ëŠ˜ë¦¬ë©´ Xmì´ ê°ì†Œí•©ë‹ˆë‹¤.`);
            }

            if (this.conditions.surface === 'poor') {
                this.result.tips.push('ìˆ˜ë©´ ìƒíƒœê°€ ë¶ˆëŸ‰í•œ ê²½ìš° ì¸¡ì • ì‹œê¸°ë¥¼ ì¡°ì •í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•˜ì„¸ìš”.');
            }
        }
    }
}
</script>
{% endblock %}
